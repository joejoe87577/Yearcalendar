function Calendar(e,t){this.element=e,null==t&&(t={}),this.init=function(e){console.debug("init called"),console.debug("init on element: "+this.element),console.debug("init with options: "+JSON.stringify(e)),this.options={start:isNaN(parseInt(t.start))?(new Date).getFullYear():parseInt(t.start),data:null!=t.data?t.data:null,lang:null!=t.lang?t.lang:"en",header:null==t.header||t.header,weeknumber:null==t.weeknumber||t.weeknumber,btnNextText:null!=t.btnNextText?t.btnNextText:">>",btnPrevText:null!=t.btnPrevText?t.btnPrevText:"<<",dayDateTimeFormat:null!=t.dayDateTimeFormat?t.dayDateTimeFormat:{day:"2-digit",weekday:"short"},monthDateTimeFormat:null!=t.monthDateTimeFormat?t.monthDateTimeFormat:{month:"long"},headerDateTimeFormat:null!=t.headerDateTimeFormat?t.headerDateTimeFormat:{year:"numeric"},onDayClick:null!=t.onDayClick?t.onDayClick:null,onYearChange:null!=t.onYearChange?t.onYearChange:null,onYearChanged:null!=t.onYearChanged?t.onYearChanged:null,renderEvents:null!=t.renderEvents?renderEvents:this.renderEvents},console.debug("used options: "+JSON.stringify(this.options)),this.currentYear=this.options.start,this.render()},this.render=function(){for(console.debug("render called for year "+this.currentYear),this.evaluateData();this.element.firstChild;)this.element.firstChild.remove();this.element.classList.add("calendar"),this.element.calendar=this;var e,t,n,a=this.prepare(this.currentYear),r=document.createElement("table"),i=document.createElement("thead"),o=document.createElement("tbody");this.options.header&&i.appendChild(this.renderHeader());new Date(this.currentYear,0,1);e=document.createElement("tr");for(var l=0;l<12;l++)t=document.createElement("th"),t.innerText=innerText=new Intl.DateTimeFormat(this.options.lang,this.options.monthDateTimeFormat).format(new Date(this.currentYear,l,1)),t.colSpan=this.options.weeknumber?3:2,e.appendChild(t);i.appendChild(e);for(l=0;l<a.maxDays;l++){e=document.createElement("tr");for(var d=0;d<12;d++)this.options.weeknumber&&(a[d].length<=l?(n=document.createElement("td"),e.appendChild(n)):a[d].length>l&&null!=a[d][l].sameWeek&&(n=document.createElement("td"),n.classList.add("weeknumber-column"),n.rowSpan=a[d][l].sameWeek,n.innerText=a[d][l].weeknumber,e.appendChild(n))),a[d].length>l?(n=document.createElement("td"),n.classList.add("day-column"),n.innerText=new Intl.DateTimeFormat(this.options.lang,this.options.dayDateTimeFormat).format(a[d][l].date),a[d][l].date.isWeekend()&&n.classList.add("day-weekend"),e.appendChild(n),n=document.createElement("td"),n.classList.add("event-column"),a[d][l].date.getMonth()==d&&(null!=a[d][l].events&&a[d][l].events.length>0&&n.appendChild(this.options.renderEvents(a[d][l].date,a[d][l].events,this.options.onDayClick)),a[d][l].date.isWeekend()&&n.classList.add("day-weekend")),e.appendChild(n)):(n=document.createElement("td"),n.colSpan=2,e.appendChild(n));o.appendChild(e)}r.appendChild(i),r.appendChild(o),this.element.appendChild(r),console.debug("render complete for year "+this.currentYear)},this.renderHeader=function(){console.debug("renderHeader called for year "+this.currentYear);var e=document.createElement("tr"),t=document.createElement("td");t.colSpan=4*(this.options.weeknumber?3:2),e.appendChild(t),t=document.createElement("td"),t.classList.add("btn-column"),t.colSpan=this.options.weeknumber?3:2;var n=document.createElement("input");n.classList.add("calendar-button","button-prev"),n.type="button",n.value=this.options.btnPrevText,n.style.float="right",n.calendar=this,n.addEventListener("click",function(e){e.currentTarget.calendar.changeYear(e.currentTarget.calendar.currentYear-1)}),t.appendChild(n),e.appendChild(t);var a=document.createElement("th");a.colSpan=2*(this.options.weeknumber?3:2),a.classList.add("year-header");var r=document.createElement("span");return r.innerText=new Intl.DateTimeFormat(this.options.lang,this.options.headerDateTimeFormat).format(new Date(this.currentYear,0,1)),a.appendChild(r),e.appendChild(a),t=document.createElement("td"),t.classList.add("btn-column"),t.colSpan=this.options.weeknumber?3:2,n=document.createElement("input"),n.classList.add("calendar-button","button-next"),n.type="button",n.value=this.options.btnNextText,n.style.float="left",n.calendar=this,n.addEventListener("click",function(e){e.currentTarget.calendar.changeYear(e.currentTarget.calendar.currentYear+1)}),t.appendChild(n),e.appendChild(t),t=document.createElement("td"),t.colSpan=4*(this.options.weeknumber?3:2),e.appendChild(t),e},this.prepare=function(e){console.debug("preparing calendar dates for year "+e);for(var t,n,a,r,i=[],o=new Date(e,0,1),l=0,d=0;l<12;){for(o=new Date(e,l,1),i[l]=[];o.getMonth()==l;){for(r=null,null!=this.data&&this.data[o.getDateComponent()]&&(r=this.data[o.getDateComponent()]),o.getWeekNumber()!=n&&(n=o.getWeekNumber(),a=0,t=o);t.getWeekNumber()==n&&t.getMonth()==l;)a++,t=t.addDays(1);i[l].push({date:o,weekday:o.getDay(),weeknumber:o.getWeekNumber(),sameWeek:null!=a?a:null,events:r}),o=o.addDays(1),a=null}i[l].length>d&&(d=i[l].length),l++}return i.maxDays=d,i},this.evaluateData=function(){console.debug("evaluating data");var e=null;if(e=this.options.data instanceof Function?this.options.data(this.currentYear):this.options.data,this.data=[],null!=e&&null!=e)for(i=0;i<e.length;i++)null==this.data[new Date(e[i].date).getDateComponent()]&&(this.data[new Date(e[i].date).getDateComponent()]=[]),this.data[new Date(e[i].date).getDateComponent()].push(e[i]);console.debug("data evaluated")},this.renderEvents=function(e,t,n){var a=document.createElement("span");return a.classList.add("event-span"),a.innerText=t.length,a.title=JSON.stringify(t),a.date=e,a.events=t,a.addEventListener("click",n),a},this.changeYear=function(e){console.debug("changing year to "+e);var t=this.currentYear,n=!0;null!=this.options.onYearChange&&(n=this.options.onYearChange(this,t,e)),(null==n||n)&&(this.currentYear=e,this.render(),null!=this.options.onYearChanged&&this.options.onYearChanged(this,t,e),console.debug("changed year to "+e))},this.init(t)}Date.prototype.addDays=function(e){var t=new Date(this.getTime());return t=t.setDate(t.getDate()+e),new Date(t)},Date.prototype.getDateComponent=function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate())},Date.prototype.isWeekend=function(){return 0==this.getDay()||6==this.getDay()},Date.prototype.getWeekNumber=function(){var e=new Date(Date.UTC(this.getFullYear(),this.getMonth(),this.getDate())),t=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-t);var n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-n)/864e5+1)/7)};